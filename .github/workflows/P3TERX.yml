name: Update Vietnam IP Lists from GeoLite2-City

on:
  schedule:
    - cron: '0 3 * * *'  # Chạy sau khi P3TERX release (2AM UTC)
  workflow_dispatch:

jobs:
  update-ip-lists:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install maxminddb-geolite2 geoip2
          
      - name: Download latest GeoLite2-City.mmdb
        run: |
          echo "Downloading latest GeoLite2-City.mmdb from P3TERX..."
          curl -L -o GeoLite2-City.mmdb \
            https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb
          ls -lh GeoLite2-City.mmdb
          
      - name: Process GeoLite2-City database
        run: |
          python << 'EOF'
          import geoip2.database
          import ipaddress
          from collections import defaultdict
          import unicodedata
          import re
          
          def normalize_city_name(city):
              """Chuẩn hóa tên thành phố"""
              if not city:
                  return 'unknown'
              
              # Bỏ dấu
              city = unicodedata.normalize('NFD', city)
              city = ''.join(char for char in city if unicodedata.category(char) != 'Mn')
              
              # Lowercase, bỏ ký tự đặc biệt
              city = city.lower()
              city = re.sub(r'[^a-z0-9]', '', city)
              
              return city if city else 'unknown'

          # Phân loại miền theo latitude threshold 17.5/13.5
          def classify_by_latitude(lat):
              if lat is None:
                  return None
              if lat >= 17.5:
                  return 'bac'
              elif lat >= 13.5:
                  return 'trung'
              else:
                  return 'nam'

          # Phân loại các tỉnh/thành phố theo miền
          MIEN_BAC = {
              'hanoi', 'haiphong', 'quangninh', 'bacninh', 'hanam', 'haduong',
              'hungyen', 'hungyenprovince', 'namdinh', 'thaibinh', 'thaibinhprovince',
              'ninhbinh', 'vinhphuc', 'bacgiang', 'phutho', 'thainguyen',
              'langson', 'langsonprovince', 'caobang', 'caobangprovince',
              'hagiang', 'tuyenquang', 'yenbai', 'laocai', 'laichau',
              'laichauprovince', 'dienbien', 'ienbienprovince', 'sonla',
              'sonlaprovince', 'hoabinh', 'thanhhoa', 'thanhhoaprovince',
              'nghean', 'ngheanprovince', 'hatinh', 'hatinhprovince', 'quangbinh'
          }
          
          MIEN_TRUNG = {
              'quangtri', 'thuathienhue', 'thuathienhueprovince', 'danang', 'danangcity',
              'quangnam', 'quangngai', 'binhdinh', 'gialai', 'kontum'
          }
          
          MIEN_NAM = {
              'hochiminh', 'hochiminhcityhcmc', 'binhduong', 'dongnai',
              'bariavungtau', 'tayninh', 'binhphuoc', 'longan', 'tiengiang',
              'bentre', 'travinh', 'vinhlong', 'dongthap', 'angiang',
              'kiengiang', 'cantho', 'canthocity', 'haugiang', 'soctrang',
              'soctrangprovince', 'baclieu', 'camau', 'daklak', 'aklak',
              'daknong', 'lamdong', 'phuyen', 'khanhhoa', 'khanhhoaprovince',
              'nhatrang', 'ninhthuan', 'binhthuan'
          }
          
          print("Đang mở GeoLite2-City.mmdb...")
          reader = geoip2.database.Reader('GeoLite2-City.mmdb')
          
          city_ips = defaultdict(list)
          mien_bac_ips = []
          mien_trung_ips = []
          mien_nam_ips = []
          vietnam_networks = []
          
          print("Đang đọc networks từ database...")
          
          # Đọc toàn bộ IPv4 networks từ database
          processed = 0
          vn_count = 0
          lat_fallback_count = 0
          
          # GeoLite2 không có API để list tất cả networks
          # Phải scan toàn bộ IPv4 space (chậm) hoặc dùng file CSV
          # Đề xuất: Download GeoLite2-City-Blocks-IPv4.csv thay vì .mmdb
          
          print("CẢNH BÁO: MMDB format không hỗ trợ list networks.")
          print("Cần dùng GeoLite2-City-CSV thay vì MMDB.")
          print("Đang chuyển sang download CSV...")
          
          reader.close()
          EOF
          
      - name: Download and process GeoLite2-City-CSV
        run: |
          python << 'EOF'
          import requests
          import zipfile
          import csv
          import ipaddress
          from collections import defaultdict
          import unicodedata
          import re
          
          def normalize_city_name(city):
              if not city:
                  return 'unknown'
              city = unicodedata.normalize('NFD', city)
              city = ''.join(char for char in city if unicodedata.category(char) != 'Mn')
              city = city.lower()
              city = re.sub(r'[^a-z0-9]', '', city)
              return city if city else 'unknown'

          def classify_by_latitude(lat):
              if lat is None:
                  return None
              try:
                  lat = float(lat)
                  if lat >= 17.5:
                      return 'bac'
                  elif lat >= 13.5:
                      return 'trung'
                  else:
                      return 'nam'
              except:
                  return None

          MIEN_BAC = {
              'hanoi', 'haiphong', 'quangninh', 'bacninh', 'hanam', 'haduong',
              'hungyen', 'hungyenprovince', 'namdinh', 'thaibinh', 'thaibinhprovince',
              'ninhbinh', 'vinhphuc', 'bacgiang', 'phutho', 'thainguyen',
              'langson', 'langsonprovince', 'caobang', 'caobangprovince',
              'hagiang', 'tuyenquang', 'yenbai', 'laocai', 'laichau',
              'laichauprovince', 'dienbien', 'ienbienprovince', 'sonla',
              'sonlaprovince', 'hoabinh', 'thanhhoa', 'thanhhoaprovince',
              'nghean', 'ngheanprovince', 'hatinh', 'hatinhprovince', 'quangbinh'
          }
          
          MIEN_TRUNG = {
              'quangtri', 'thuathienhue', 'thuathienhueprovince', 'danang', 'danangcity',
              'quangnam', 'quangngai', 'binhdinh', 'gialai', 'kontum'
          }
          
          MIEN_NAM = {
              'hochiminh', 'hochiminhcityhcmc', 'binhduong', 'dongnai',
              'bariavungtau', 'tayninh', 'binhphuoc', 'longan', 'tiengiang',
              'bentre', 'travinh', 'vinhlong', 'dongthap', 'angiang',
              'kiengiang', 'cantho', 'canthocity', 'haugiang', 'soctrang',
              'soctrangprovince', 'baclieu', 'camau', 'daklak', 'aklak',
              'daknong', 'lamdong', 'phuyen', 'khanhhoa', 'khanhhoaprovince',
              'nhatrang', 'ninhthuan', 'binhthuan'
          }
          
          print("Downloading GeoLite2-City-CSV from P3TERX...")
          url = "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City-CSV.zip"
          response = requests.get(url, stream=True)
          
          with open('GeoLite2-City-CSV.zip', 'wb') as f:
              f.write(response.content)
          
          print("Extracting ZIP file...")
          with zipfile.ZipFile('GeoLite2-City-CSV.zip', 'r') as zip_ref:
              zip_ref.extractall('geolite2')
          
          # Tìm file blocks và locations
          import os
          import glob
          
          blocks_file = glob.glob('geolite2/*/GeoLite2-City-Blocks-IPv4.csv')[0]
          locations_file = glob.glob('geolite2/*/GeoLite2-City-Locations-en.csv')[0]
          
          print(f"Reading locations from {locations_file}...")
          
          # Đọc locations (geoname_id -> city_name, latitude)
          locations = {}
          with open(locations_file, 'r', encoding='utf-8') as f:
              reader = csv.DictReader(f)
              for row in reader:
                  if row['country_iso_code'] == 'VN':
                      geoname_id = row['geoname_id']
                      city_name = row.get('city_name', '') or row.get('subdivision_1_name', '') or 'Unknown'
                      latitude = row.get('latitude', '')
                      locations[geoname_id] = {
                          'city': city_name,
                          'latitude': latitude
                      }
          
          print(f"Found {len(locations)} VN locations")
          print(f"Reading networks from {blocks_file}...")
          
          city_ips = defaultdict(list)
          mien_bac_ips = []
          mien_trung_ips = []
          mien_nam_ips = []
          vietnam_networks = []
          
          lat_fallback_count = 0
          city_match_count = 0
          unknown_count = 0
          
          with open(blocks_file, 'r', encoding='utf-8') as f:
              reader = csv.DictReader(f)
              for row in reader:
                  geoname_id = row.get('geoname_id', '')
                  
                  if geoname_id in locations:
                      network = row['network']
                      loc = locations[geoname_id]
                      city_name = loc['city']
                      latitude = loc['latitude']
                      
                      city_normalized = normalize_city_name(city_name)
                      
                      city_ips[city_normalized].append(network)
                      vietnam_networks.append(network)
                      
                      # Phân loại theo city name trước
                      region = None
                      if city_normalized in MIEN_BAC:
                          region = 'bac'
                          city_match_count += 1
                      elif city_normalized in MIEN_TRUNG:
                          region = 'trung'
                          city_match_count += 1
                      elif city_normalized in MIEN_NAM:
                          region = 'nam'
                          city_match_count += 1
                      
                      # Fallback: dùng latitude
                      if region is None:
                          region = classify_by_latitude(latitude)
                          if region:
                              lat_fallback_count += 1
                          else:
                              unknown_count += 1
                      
                      # Thêm vào danh sách miền
                      if region == 'bac':
                          mien_bac_ips.append(network)
                      elif region == 'trung':
                          mien_trung_ips.append(network)
                      elif region == 'nam':
                          mien_nam_ips.append(network)
          
          print(f"\n=== THỐNG KÊ ===")
          print(f"Tổng networks VN: {len(vietnam_networks)}")
          print(f"Phân loại theo city name: {city_match_count}")
          print(f"Phân loại theo latitude: {lat_fallback_count}")
          print(f"Không xác định: {unknown_count}")
          print(f"Số thành phố/tỉnh: {len(city_ips)}")
          
          # Lưu file
          unique_all = sorted(set(vietnam_networks), key=lambda x: ipaddress.ip_network(x))
          with open('vietnam.txt', 'w') as f:
              for network in unique_all:
                  f.write(network + '\n')
          print(f"\nĐã lưu vietnam.txt với {len(unique_all)} networks")
          
          unique_mien_bac = sorted(set(mien_bac_ips), key=lambda x: ipaddress.ip_network(x))
          with open('mien_bac.txt', 'w') as f:
              for network in unique_mien_bac:
                  f.write(network + '\n')
          print(f"Đã lưu mien_bac.txt với {len(unique_mien_bac)} networks")
          
          unique_mien_trung = sorted(set(mien_trung_ips), key=lambda x: ipaddress.ip_network(x))
          with open('mien_trung.txt', 'w') as f:
              for network in unique_mien_trung:
                  f.write(network + '\n')
          print(f"Đã lưu mien_trung.txt với {len(unique_mien_trung)} networks")
          
          unique_mien_nam = sorted(set(mien_nam_ips), key=lambda x: ipaddress.ip_network(x))
          with open('mien_nam.txt', 'w') as f:
              for network in unique_mien_nam:
                  f.write(network + '\n')
          print(f"Đã lưu mien_nam.txt với {len(unique_mien_nam)} networks")
          
          print("\n=== Top 10 thành phố có nhiều networks nhất ===")
          sorted_cities = sorted(city_ips.items(), key=lambda x: len(set(x[1])), reverse=True)[:10]
          for city, networks in sorted_cities:
              print(f"{city}: {len(set(networks))} networks")
          
          print("\n=== Thống kê theo miền ===")
          print(f"Miền Bắc: {len(unique_mien_bac)} networks")
          print(f"Miền Trung: {len(unique_mien_trung)} networks")
          print(f"Miền Nam: {len(unique_mien_nam)} networks")
          
          print("\nHoàn thành!")
          EOF
          
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add *.txt
          git commit -m "Update Vietnam IP lists from GeoLite2-City [$(date +'%Y-%m-%d')]" || exit 0
          git push
